services:
  # ---------------------------------------------------
  # 1. MESSAGE BROKER (The "Nervous System")
  # ---------------------------------------------------
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    ports:
      - "1883:1883"     # MQTT port
      - "9001:9001"     # WebSockets port (useful for web dashboards later)
    volumes:
      # Map a local config file to the container (optional but recommended for stability)
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 2. MANAGED RESOURCES (The Simulator)
  # ---------------------------------------------------
  managed_resources:
    build: ./managed_resources
    container_name: managed_resources
    environment:
      - MQTT_BROKER=mosquitto  # Tells Python to connect to the service named 'mosquitto'
    depends_on:
      - mosquitto
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 3. DATABASE (InfluxDB)
  # ---------------------------------------------------
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: always
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=AIops_org
      - DOCKER_INFLUXDB_INIT_BUCKET=AIops_bucket
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-admin-token
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 4. DATA COLLECTOR (Telegraf)
  # ---------------------------------------------------
  telegraf:
    image: telegraf:latest
    container_name: telegraf
    restart: always
    depends_on:
      - influxdb
      - mosquitto
    volumes:
      - ./monitor/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 5. ANALYZER (MAPE-K: Analyze)
  # ---------------------------------------------------
  analyzer:
    build: ./analyzer
    container_name: analyzer
    depends_on:
      - influxdb
    networks:
      - aiops_network

# Define a custom network so containers can talk to each other by name
networks:
  aiops_network:
    driver: bridge