services:
  # ---------------------------------------------------
  # 1. MESSAGE BROKER
  # ---------------------------------------------------
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: aiops_mosquitto
    ports:
      - "1883:1883"     # MQTT port
      - "9001:9001"     # WebSockets port (useful for web dashboards later)
    volumes:
      # Map a local config file to the container (optional but recommended for stability)
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 2. MANAGED RESOURCES (The Simulator)
  # ---------------------------------------------------
  managed_resources:
    build: ./managed_resources
    container_name: AIops_managed_resources
    env_file:
      - .env
    depends_on:
      - mosquitto
    networks:
      - aiops_network
    volumes:
      - ./config/config.ini:/app/config.ini:ro

  # ---------------------------------------------------
  # 3. DATABASE (InfluxDB)
  # ---------------------------------------------------
  influxdb:
    image: influxdb:2.7
    container_name: AIops_influxdb
    restart: always
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_USERNAME}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN}
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 4. DATA COLLECTOR (Telegraf)
  # ---------------------------------------------------
  telegraf:
    image: telegraf:latest
    container_name: AIops_telegraf
    restart: always
    env_file:
      - .env
    depends_on:
      - mosquitto
      - influxdb
    volumes:
      - ./monitor/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    networks:
      - aiops_network

  # ---------------------------------------------------
  # 5. ANALYZER
  # ---------------------------------------------------
  analyzer:
    build: ./analyzer
    container_name: AIops_analyzer
    env_file:
      - .env
    depends_on:
      - mosquitto
      - influxdb
      - ollama_docker
    networks:
      - aiops_network
    volumes:
      - ./config/config.ini:/app/config.ini:ro

  # ---------------------------------------------------
  # 6. PLANNER
  # ---------------------------------------------------
  planner:
    build: ./planner
    container_name: AIops_planner
    env_file:
      - .env
    depends_on:
      - mosquitto
      - influxdb
      - ollama_docker
    networks:
      - aiops_network
    volumes:
      - ./config/config.ini:/app/config.ini:ro

  # ---------------------------------------------------
  # 7. EXECUTOR
  # ---------------------------------------------------
  executor:
    build: ./executor
    container_name: AIops_executor
    env_file:
      - .env
    depends_on:
      - mosquitto
      - influxdb
      - ollama_docker
    networks:
      - aiops_network
    volumes:
      - ./config/config.ini:/app/config.ini:ro

  # ---------------------------------------------------
  # 8. LLM EXPLAINER
  # ---------------------------------------------------
  ollama_docker:
    build:
      context: ./ollama_docker
    container_name: AIops_ollama_docker
    env_file:
      - .env
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - aiops_network
    restart: unless-stopped

  # ---------------------------------------------------
  # 9. GATEWAY API (Spring Boot)
  # ---------------------------------------------------
  aiops_api:
    build: ./aiops_api
    container_name: AIops_api
    env_file:
      - .env
    ports:
      - "8080:8080"
    depends_on:
      - influxdb
    networks:
      - aiops_network
    volumes:
      - ./config/config.ini:/app/config.ini:ro
    restart: unless-stopped

  # ---------------------------------------------------
  # 10. FRONTEND DASHBOARD (Vue.js)
  # ---------------------------------------------------
  dashboard:
    build: ./dashboard
    container_name: AIops_dashboard
    ports:
      - "3000:80"
    depends_on:
      - aiops_api
    networks:
      - aiops_network
    restart: always

volumes:
  ollama_data:

# Define a custom network so containers can talk to each other by name
networks:
  aiops_network:
    driver: bridge